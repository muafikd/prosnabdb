# Решение проблемы с calculated_data

## Резюме проблемы

При сохранении КП в модальной форме "Расчет КП", расчетные данные записываются в поле `equipment_list_item.calculated_data`. При следующем редактировании КП эти данные загружаются, но показывают неправильные значения.

## Что было найдено

### 1. Данные, которые сохраняются в calculated_data:

При сохранении КП в `_save_prices_to_equipment_list_items()` сохраняются следующие поля:
- `base_cost_kzt` - себестоимость единицы (цена закупки + расходы на строку)
- `allocated_overhead_per_unit` - распределенные общие расходы на единицу
- `margin_kzt` - маржа в тенге на единицу
- `margin_percentage` - маржа в процентах
- `purchase_price_kzt` - цена закупки в тенге (ДО добавления расходов на строку)

### 2. Откуда загружаются данные при редактировании:

При редактировании КП данные загружаются из:
- `equipment_items_data[].calculated_data` (из EquipmentListItem) - приоритет
- `data_package.equipment_list[]` - fallback если calculated_data пусто

### 3. Проблема:

**При сохранении КП всегда происходит пересчет всех данных заново** на основе текущих цен оборудования через `DataAggregatorService.get_full_data_package()`. 

Это означает, что если между сохранениями изменились:
- Цены оборудования (`sale_price_kzt`)
- Цены закупки
- Общие расходы
- Курсы валют
- Row expenses

То сохраненные значения в `calculated_data` будут **другими**, чем при предыдущем сохранении.

## Добавлено логирование

Для диагностики проблемы добавлено логирование:

1. **На бэкенде** (serializers.py):
   - Логирование старых и новых значений `calculated_data` при сохранении
   - Показывает, что именно сохраняется для каждого equipment_id

2. **На фронтенде** (ProposalsView.vue):
   - Логирование загружаемых данных при редактировании КП
   - Показывает, какие значения берутся из `calculated_data` и fallback

## Рекомендации для дальнейшей диагностики

1. **Проверить логи** при сохранении и загрузке КП:
   - Сравнить значения, которые сохраняются
   - Сравнить значения, которые загружаются
   - Найти расхождения

2. **Проверить, изменяются ли цены оборудования**:
   - Проверить, не изменяется ли `sale_price_kzt` между сохранениями
   - Проверить, не изменяются ли цены закупки

3. **Проверить, изменяются ли общие расходы**:
   - Проверить, не изменяются ли `additional_price_ids` между сохранениями
   - Проверить, не изменяются ли курсы валют

4. **Проверить, правильно ли сохраняются данные**:
   - Убедиться, что данные сохраняются в правильном формате
   - Убедиться, что данные не теряются при сохранении

## Возможные решения

### Вариант 1: Сохранять данные из формы (не пересчитывать)

Если нужно сохранять именно те значения, которые были в форме, а не пересчитывать:
- Передавать расчетные данные из фронтенда при сохранении
- Сохранять их без пересчета на бэкенде

### Вариант 2: Не пересчитывать при обновлении (только при создании)

Если нужно сохранять значения, которые были при первом сохранении:
- Пересчитывать только при создании КП
- При обновлении использовать сохраненные значения из `calculated_data`

### Вариант 3: Использовать снимок цен на момент создания КП

Если нужно зафиксировать цены на момент создания КП:
- Сохранять снимок цен оборудования в момент создания КП
- Использовать этот снимок для расчетов при обновлении

## Следующие шаги

1. Запустить приложение и проверить логи при сохранении/загрузке КП
2. Сравнить сохраненные и загруженные значения
3. Определить, какое решение подходит для вашего случая
4. Реализовать выбранное решение
