# Интеграция Bitrix24

## Настройка

1. **Вебхук** — в Bitrix24: Приложения → Разработчикам → Входящий вебхук. Создайте вебхук с правами **CRM** (компании, контакты, сделки).
2. **В системе** — укажите URL вебхука в настройках (главная страница, виджет для администратора) или через API `PATCH /api/system-settings/` (`bitrix_webhook_url`).

Формат URL: `https://ваш-портал.bitrix24.com/rest/1/КОД/`

## Возможности

- **Проверка связи** — `POST /api/bitrix/check/` (вызов `crm.company.list` limit 1).
- **Поиск** — `GET /api/bitrix/search/?type=name|contact|requisite|deal&q=...` (компании по названию/контакту/БИН, сделки по названию).
- **Импорт компании** — `POST /api/bitrix/import-client/` с `bitrix_id` (ID компании). Создаёт/обновляет клиента в локальной БД.
- **Выбор сделки** — `POST /api/bitrix/select-deal/` с `bitrix_deal_id`. Сохраняет сделку в `crm_deal_list` (в т.ч. название стадии, контакт, телефон), при наличии компании импортирует её в `clients`.

## Локальные сущности

- **Сделки** — таблица `crm_deal_list` (CrmDeal): название, стадия (код + читаемое название), компания, контакт, телефон контакта, ссылка на Bitrix.
- **Клиенты** — при импорте из Bitrix заполняются реквизиты (БИН, адрес, телефон и т.д.).

## Если поиск не находит данные

Проверьте права вебхука в Bitrix24 (CRM). При ограниченных правах для поиска компаний по названию используется запасной вариант: загрузка первой порции списка и фильтрация по названию на стороне приложения.
